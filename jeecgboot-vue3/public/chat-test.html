<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIèŠå¤©æ¥å…¥æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .config-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .config-panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e8e8e8;
        }
        
        .btn-success {
            background: #52c41a;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a617;
        }
        
        .test-area {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .test-panel {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .test-panel h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            font-size: 16px;
        }
        
        .test-content {
            padding: 20px;
            min-height: 500px;
            background: #f9f9f9;
        }
        
        .test-content iframe {
            width: 100%;
            height: 500px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: white;
        }
        
        .code-block {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            overflow-x: auto;
        }
        
        .code-block pre {
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .code-block .keyword { color: #569cd6; }
        .code-block .string { color: #ce9178; }
        .code-block .tag { color: #569cd6; }
        .code-block .attr { color: #9cdcfe; }
        
        .tabs {
            display: flex;
            background: #f0f0f0;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 0 0 8px 8px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tip {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #0050b3;
            font-size: 14px;
        }
        
        .tip::before {
            content: "ğŸ’¡ ";
        }
        
        #scriptContainer {
            position: relative;
        }
        
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .copy-btn:hover {
            background: #5a6fd6;
        }
        
        @media (max-width: 768px) {
            .test-area {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– AIèŠå¤©æ¥å…¥æµ‹è¯•</h1>
        
        <div class="config-panel">
            <h2>âš™ï¸ é…ç½®å‚æ•°</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>æœåŠ¡å™¨åœ°å€</label>
                    <input type="text" id="serverUrl" value="http://localhost:3100" placeholder="http://localhost:3100">
                </div>
                <div class="form-group">
                    <label>åº”ç”¨ID (appId)</label>
                    <input type="text" id="appId" placeholder="è¯·è¾“å…¥åº”ç”¨ID">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>å¤–éƒ¨ç”¨æˆ·ID</label>
                    <input type="text" id="externalUserId" value="test_user_001" placeholder="ç”¨æˆ·å”¯ä¸€æ ‡è¯†">
                </div>
                <div class="form-group">
                    <label>å¤–éƒ¨ç”¨æˆ·å</label>
                    <input type="text" id="externalUserName" value="æµ‹è¯•ç”¨æˆ·" placeholder="æ˜¾ç¤ºçš„ç”¨æˆ·å">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ä¼šè¯æ¨¡å¼</label>
                    <select id="sessionMode">
                        <option value="persist">æŒä¹…ä¼šè¯ (persist)</option>
                        <option value="temporary">ä¸´æ—¶ä¼šè¯ (temporary)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¯†é’¥ (å¯é€‰)</label>
                    <input type="text" id="secretKey" placeholder="ç•™ç©ºåˆ™æ— ç­¾åéªŒè¯">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="loadIframe()">ğŸš€ åŠ è½½iframeæµ‹è¯•</button>
                <button class="btn btn-success" onclick="loadScript()">ğŸ“œ åŠ è½½Scriptæµ‹è¯•</button>
                <button class="btn btn-secondary" onclick="generateCode()">ğŸ“‹ ç”Ÿæˆä»£ç </button>
            </div>
        </div>
        
        <div class="test-area">
            <div class="test-panel" style="flex: 2;">
                <h3>ğŸ“º é¢„è§ˆåŒºåŸŸ</h3>
                <div class="test-content" id="previewArea">
                    <div class="tip">è¯·å…ˆé…ç½®å‚æ•°ï¼Œç„¶åç‚¹å‡»"åŠ è½½iframeæµ‹è¯•"æˆ–"åŠ è½½Scriptæµ‹è¯•"æŒ‰é’®</div>
                    <div id="iframeContainer"></div>
                    <div id="scriptContainer"></div>
                </div>
            </div>
            
            <div class="test-panel" style="flex: 1;">
                <h3>ğŸ“ ç”Ÿæˆçš„ä»£ç </h3>
                <div style="padding: 0;">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('iframe')">iframe</button>
                        <button class="tab" onclick="switchTab('script')">Script</button>
                    </div>
                    <div class="tab-content active" id="iframeTab">
                        <p style="color: #666; font-size: 14px; margin-bottom: 12px;">å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ°ä½ çš„ç½‘é¡µä¸­ï¼š</p>
                        <div class="code-block" style="position: relative;">
                            <button class="copy-btn" onclick="copyCode('iframeCode')">å¤åˆ¶</button>
                            <pre id="iframeCode">&lt;iframe 
  src="è¯·å…ˆé…ç½®å‚æ•°"
  style="width: 100%; height: 600px; border: none;"&gt;
&lt;/iframe&gt;</pre>
                        </div>
                    </div>
                    <div class="tab-content" id="scriptTab">
                        <p style="color: #666; font-size: 14px; margin-bottom: 12px;">å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ°ä½ çš„ç½‘é¡µä¸­ï¼š</p>
                        <div class="code-block" style="position: relative;">
                            <button class="copy-btn" onclick="copyCode('scriptCode')">å¤åˆ¶</button>
                            <pre id="scriptCode">&lt;script src="è¯·å…ˆé…ç½®å‚æ•°"&gt;&lt;/script&gt;</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // MD5å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼Œç”¨äºç”Ÿæˆtokenï¼‰
        function md5(string) {
            function md5cycle(x, k) {
                var a = x[0], b = x[1], c = x[2], d = x[3];
                a = ff(a, b, c, d, k[0], 7, -680876936);
                d = ff(d, a, b, c, k[1], 12, -389564586);
                c = ff(c, d, a, b, k[2], 17, 606105819);
                b = ff(b, c, d, a, k[3], 22, -1044525330);
                a = ff(a, b, c, d, k[4], 7, -176418897);
                d = ff(d, a, b, c, k[5], 12, 1200080426);
                c = ff(c, d, a, b, k[6], 17, -1473231341);
                b = ff(b, c, d, a, k[7], 22, -45705983);
                a = ff(a, b, c, d, k[8], 7, 1770035416);
                d = ff(d, a, b, c, k[9], 12, -1958414417);
                c = ff(c, d, a, b, k[10], 17, -42063);
                b = ff(b, c, d, a, k[11], 22, -1990404162);
                a = ff(a, b, c, d, k[12], 7, 1804603682);
                d = ff(d, a, b, c, k[13], 12, -40341101);
                c = ff(c, d, a, b, k[14], 17, -1502002290);
                b = ff(b, c, d, a, k[15], 22, 1236535329);
                a = gg(a, b, c, d, k[1], 5, -165796510);
                d = gg(d, a, b, c, k[6], 9, -1069501632);
                c = gg(c, d, a, b, k[11], 14, 643717713);
                b = gg(b, c, d, a, k[0], 20, -373897302);
                a = gg(a, b, c, d, k[5], 5, -701558691);
                d = gg(d, a, b, c, k[10], 9, 38016083);
                c = gg(c, d, a, b, k[15], 14, -660478335);
                b = gg(b, c, d, a, k[4], 20, -405537848);
                a = gg(a, b, c, d, k[9], 5, 568446438);
                d = gg(d, a, b, c, k[14], 9, -1019803690);
                c = gg(c, d, a, b, k[3], 14, -187363961);
                b = gg(b, c, d, a, k[8], 20, 1163531501);
                a = gg(a, b, c, d, k[13], 5, -1444681467);
                d = gg(d, a, b, c, k[2], 9, -51403784);
                c = gg(c, d, a, b, k[7], 14, 1735328473);
                b = gg(b, c, d, a, k[12], 20, -1926607734);
                a = hh(a, b, c, d, k[5], 4, -378558);
                d = hh(d, a, b, c, k[8], 11, -2022574463);
                c = hh(c, d, a, b, k[11], 16, 1839030562);
                b = hh(b, c, d, a, k[14], 23, -35309556);
                a = hh(a, b, c, d, k[1], 4, -1530992060);
                d = hh(d, a, b, c, k[4], 11, 1272893353);
                c = hh(c, d, a, b, k[7], 16, -155497632);
                b = hh(b, c, d, a, k[10], 23, -1094730640);
                a = hh(a, b, c, d, k[13], 4, 681279174);
                d = hh(d, a, b, c, k[0], 11, -358537222);
                c = hh(c, d, a, b, k[3], 16, -722521979);
                b = hh(b, c, d, a, k[6], 23, 76029189);
                a = hh(a, b, c, d, k[9], 4, -640364487);
                d = hh(d, a, b, c, k[12], 11, -421815835);
                c = hh(c, d, a, b, k[15], 16, 530742520);
                b = hh(b, c, d, a, k[2], 23, -995338651);
                a = ii(a, b, c, d, k[0], 6, -198630844);
                d = ii(d, a, b, c, k[7], 10, 1126891415);
                c = ii(c, d, a, b, k[14], 15, -1416354905);
                b = ii(b, c, d, a, k[5], 21, -57434055);
                a = ii(a, b, c, d, k[12], 6, 1700485571);
                d = ii(d, a, b, c, k[3], 10, -1894986606);
                c = ii(c, d, a, b, k[10], 15, -1051523);
                b = ii(b, c, d, a, k[1], 21, -2054922799);
                a = ii(a, b, c, d, k[8], 6, 1873313359);
                d = ii(d, a, b, c, k[15], 10, -30611744);
                c = ii(c, d, a, b, k[6], 15, -1560198380);
                b = ii(b, c, d, a, k[13], 21, 1309151649);
                a = ii(a, b, c, d, k[4], 6, -145523070);
                d = ii(d, a, b, c, k[11], 10, -1120210379);
                c = ii(c, d, a, b, k[2], 15, 718787259);
                b = ii(b, c, d, a, k[9], 21, -343485551);
                x[0] = add32(a, x[0]);
                x[1] = add32(b, x[1]);
                x[2] = add32(c, x[2]);
                x[3] = add32(d, x[3]);
            }
            function cmn(q, a, b, x, s, t) {
                a = add32(add32(a, q), add32(x, t));
                return add32((a << s) | (a >>> (32 - s)), b);
            }
            function ff(a, b, c, d, x, s, t) { return cmn((b & c) | ((~b) & d), a, b, x, s, t); }
            function gg(a, b, c, d, x, s, t) { return cmn((b & d) | (c & (~d)), a, b, x, s, t); }
            function hh(a, b, c, d, x, s, t) { return cmn(b ^ c ^ d, a, b, x, s, t); }
            function ii(a, b, c, d, x, s, t) { return cmn(c ^ (b | (~d)), a, b, x, s, t); }
            function md51(s) {
                var n = s.length,
                    state = [1732584193, -271733879, -1732584194, 271733878], i;
                for (i = 64; i <= s.length; i += 64) {
                    md5cycle(state, md5blk(s.substring(i - 64, i)));
                }
                s = s.substring(i - 64);
                var tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                for (i = 0; i < s.length; i++)
                    tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);
                tail[i >> 2] |= 0x80 << ((i % 4) << 3);
                if (i > 55) {
                    md5cycle(state, tail);
                    for (i = 0; i < 16; i++) tail[i] = 0;
                }
                tail[14] = n * 8;
                md5cycle(state, tail);
                return state;
            }
            function md5blk(s) {
                var md5blks = [], i;
                for (i = 0; i < 64; i += 4) {
                    md5blks[i >> 2] = s.charCodeAt(i) + (s.charCodeAt(i + 1) << 8) + (s.charCodeAt(i + 2) << 16) + (s.charCodeAt(i + 3) << 24);
                }
                return md5blks;
            }
            var hex_chr = '0123456789abcdef'.split('');
            function rhex(n) {
                var s = '', j = 0;
                for (; j < 4; j++)
                    s += hex_chr[(n >> (j * 8 + 4)) & 0x0F] + hex_chr[(n >> (j * 8)) & 0x0F];
                return s;
            }
            function hex(x) {
                for (var i = 0; i < x.length; i++)
                    x[i] = rhex(x[i]);
                return x.join('');
            }
            function add32(a, b) { return (a + b) & 0xFFFFFFFF; }
            return hex(md51(string));
        }
        
        function getConfig() {
            return {
                serverUrl: document.getElementById('serverUrl').value.replace(/\/$/, ''),
                appId: document.getElementById('appId').value,
                externalUserId: document.getElementById('externalUserId').value,
                externalUserName: document.getElementById('externalUserName').value,
                sessionMode: document.getElementById('sessionMode').value,
                secretKey: document.getElementById('secretKey').value
            };
        }
        
        function buildChatUrl(config) {
            const params = new URLSearchParams();
            params.append('externalUserId', config.externalUserId);
            params.append('externalUserName', config.externalUserName);
            params.append('sessionMode', config.sessionMode);
            
            if (config.secretKey) {
                const timestamp = Date.now();
                const token = md5(config.appId + config.secretKey + timestamp);
                params.append('token', token);
                params.append('timestamp', timestamp);
            }
            
            return `${config.serverUrl}/ai/app/chat/${config.appId}?${params.toString()}`;
        }
        
        function loadIframe() {
            const config = getConfig();
            
            if (!config.appId) {
                alert('è¯·å…ˆè¾“å…¥åº”ç”¨ID');
                return;
            }
            
            const url = buildChatUrl(config);
            const container = document.getElementById('iframeContainer');
            container.innerHTML = `<iframe src="${url}" style="width: 100%; height: 500px; border: 1px solid #eee; border-radius: 8px;"></iframe>`;
            
            document.getElementById('scriptContainer').innerHTML = '';
            generateCode();
        }
        
        function loadScript() {
            const config = getConfig();
            
            if (!config.appId) {
                alert('è¯·å…ˆè¾“å…¥åº”ç”¨ID');
                return;
            }
            
            // æ¸…ç†ä¹‹å‰çš„
            document.getElementById('iframeContainer').innerHTML = '';
            const container = document.getElementById('scriptContainer');
            container.innerHTML = '<div id="ai-chat-widget"></div>';
            
            // ç§»é™¤ä¹‹å‰åŠ è½½çš„è„šæœ¬
            const oldScript = document.getElementById('ai-chat-script');
            if (oldScript) {
                oldScript.remove();
            }
            
            // åŠ¨æ€åŠ è½½è„šæœ¬
            const script = document.createElement('script');
            script.id = 'ai-chat-script';
            script.src = `${config.serverUrl}/chat/chat.js`;
            script.onload = function() {
                if (typeof createAiChat === 'function') {
                    const options = {
                        appId: config.appId,
                        externalUserId: config.externalUserId,
                        externalUserName: config.externalUserName,
                        sessionMode: config.sessionMode,
                        iconPosition: 'bottom-right',
                        showWelcomePage: true
                    };
                    
                    if (config.secretKey) {
                        const timestamp = Date.now();
                        options.token = md5(config.appId + config.secretKey + timestamp);
                        options.timestamp = timestamp;
                    }
                    
                    createAiChat(options);
                }
            };
            document.body.appendChild(script);
            
            generateCode();
        }
        
        function generateCode() {
            const config = getConfig();
            const url = buildChatUrl(config);
            
            // iframeä»£ç 
            const iframeHtml = `&lt;iframe 
  src="${url}"
  style="width: 100%; height: 600px; border: none;"&gt;
&lt;/iframe&gt;`;
            document.getElementById('iframeCode').innerHTML = iframeHtml;
            
            // Scriptä»£ç 
            let scriptHtml = `&lt;script src="${config.serverUrl}/chat/chat.js"&gt;&lt;/script&gt;
&lt;script&gt;
  createAiChat({
    appId: "${config.appId}",
    externalUserId: "${config.externalUserId}",
    externalUserName: "${config.externalUserName}",
    sessionMode: "${config.sessionMode}",`;
            
            if (config.secretKey) {
                scriptHtml += `
    // æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶tokenåº”åœ¨æœåŠ¡ç«¯ç”Ÿæˆ
    token: "YOUR_SERVER_GENERATED_TOKEN",
    timestamp: Date.now(),`;
            }
            
            scriptHtml += `
    iconPosition: "bottom-right",
    showWelcomePage: true
  });
&lt;/script&gt;`;
            document.getElementById('scriptCode').innerHTML = scriptHtml;
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab:nth-child(${tab === 'iframe' ? 1 : 2})`).classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }
        
        function copyCode(elementId) {
            const element = document.getElementById(elementId);
            const text = element.innerText
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&');
            
            navigator.clipboard.writeText(text).then(() => {
                alert('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆé»˜è®¤ä»£ç 
        window.onload = function() {
            generateCode();
        };
    </script>
</body>
</html>
